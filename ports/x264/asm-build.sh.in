#!/bin/sh

set -e

export PATH="/usr/bin:$PATH"

command -v cygpath >/dev/null && have_cygpath=1

cygpath() {
    if [ -n "$have_cygpath" ]; then
        command cygpath "$@"
    else
        eval _p='$'$#
        printf '%s\n' "$_p"
    fi
}

X264_ARCH=@X264_ARCH@
SOURCE_PATH=$(cygpath "@SOURCE_PATH@")
if [ ${X264_ARCH} = "armv7" ]; then
SYS_ARCH=arm
elif [ ${X264_ARCH} = "arm64" ]; then
SYS_ARCH=aarch64
fi

CURRENT_DIR=$(pwd)

if [ ! -f "@PACKAGES_DIR@/libx264.a" ]; then
    exit 1
fi

tool_ar=$(xcrun --find ar)
if [ ! -f "${tool_ar}" ]; then
    exit 2
fi

tool_ranlib=$(xcrun --find ranlib)
if [ ! -f "${tool_ranlib}" ]; then
    exit 2
fi

if [ ${X264_ARCH} = "arm64" ]; then
    echo "rebuild asm object."
    rm -rf common/${SYS_ARCH}/bitstream-a-8.o common/${SYS_ARCH}/cabac-a-8.o common/${SYS_ARCH}/dct-a-8.o common/${SYS_ARCH}/deblock-a-8.o common/${SYS_ARCH}/mc-a-8.o common/${SYS_ARCH}/pixel-a-8.o common/${SYS_ARCH}/predict-a-8.o common/${SYS_ARCH}/quant-a-8.o common/${SYS_ARCH}/bitstream-a-10.o common/${SYS_ARCH}/cabac-a-10.o common/${SYS_ARCH}/dct-a-10.o common/${SYS_ARCH}/deblock-a-10.o common/${SYS_ARCH}/mc-a-10.o common/${SYS_ARCH}/pixel-a-10.o common/${SYS_ARCH}/predict-a-10.o common/${SYS_ARCH}/quant-a-10.o
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/bitstream-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/bitstream-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/cabac-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/cabac-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/dct-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/dct-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/deblock-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/deblock-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/mc-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/mc-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/pixel-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/pixel-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/predict-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/predict-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/quant-a-8.o ${SOURCE_PATH}/common/${SYS_ARCH}/quant-a.S -DHIGH_BIT_DEPTH=0 -DBIT_DEPTH=8
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/bitstream-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/bitstream-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/cabac-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/cabac-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/dct-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/dct-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/deblock-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/deblock-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/mc-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/mc-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/pixel-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/pixel-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/predict-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/predict-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10
    ${AS} -I. -I${SOURCE_PATH} -DPREFIX -DPIC -arch ${X264_ARCH} -c -DSTACK_ALIGNMENT=16 -o common/${SYS_ARCH}/quant-a-10.o ${SOURCE_PATH}/common/${SYS_ARCH}/quant-a.S -DHIGH_BIT_DEPTH=1 -DBIT_DEPTH=10

    rm -f @PACKAGES_DIR@/libx264.a
    ${tool_ar} -v -r @PACKAGES_DIR@/libx264.a  common/osdep.o common/base.o common/cpu.o common/tables.o encoder/api.o common/mc-8.o common/predict-8.o common/pixel-8.o common/macroblock-8.o common/frame-8.o common/dct-8.o common/cabac-8.o common/common-8.o common/rectangle-8.o common/set-8.o common/quant-8.o common/deblock-8.o common/vlc-8.o common/mvpred-8.o common/bitstream-8.o encoder/analyse-8.o encoder/me-8.o encoder/ratecontrol-8.o encoder/set-8.o encoder/macroblock-8.o encoder/cabac-8.o encoder/cavlc-8.o encoder/encoder-8.o encoder/lookahead-8.o common/threadpool-8.o common/${SYS_ARCH}/asm-offsets-8.o common/${SYS_ARCH}/mc-c-8.o common/${SYS_ARCH}/predict-c-8.o common/opencl-8.o encoder/slicetype-cl-8.o common/mc-10.o common/predict-10.o common/pixel-10.o common/macroblock-10.o common/frame-10.o common/dct-10.o common/cabac-10.o common/common-10.o common/rectangle-10.o common/set-10.o common/quant-10.o common/deblock-10.o common/vlc-10.o common/mvpred-10.o common/bitstream-10.o encoder/analyse-10.o encoder/me-10.o encoder/ratecontrol-10.o encoder/set-10.o encoder/macroblock-10.o encoder/cabac-10.o encoder/cavlc-10.o encoder/encoder-10.o encoder/lookahead-10.o common/threadpool-10.o common/${SYS_ARCH}/asm-offsets-10.o common/${SYS_ARCH}/mc-c-10.o common/${SYS_ARCH}/predict-c-10.o   common/${SYS_ARCH}/bitstream-a-8.o common/${SYS_ARCH}/cabac-a-8.o common/${SYS_ARCH}/dct-a-8.o common/${SYS_ARCH}/deblock-a-8.o common/${SYS_ARCH}/mc-a-8.o common/${SYS_ARCH}/pixel-a-8.o common/${SYS_ARCH}/predict-a-8.o common/${SYS_ARCH}/quant-a-8.o common/${SYS_ARCH}/bitstream-a-10.o common/${SYS_ARCH}/cabac-a-10.o common/${SYS_ARCH}/dct-a-10.o common/${SYS_ARCH}/deblock-a-10.o common/${SYS_ARCH}/mc-a-10.o common/${SYS_ARCH}/pixel-a-10.o common/${SYS_ARCH}/predict-a-10.o common/${SYS_ARCH}/quant-a-10.o
    ${tool_ranlib} @PACKAGES_DIR@/libx264.a
fi



# if [ -f “@PACKAGES_DIR@/libx2641.a” ]; then
    # rm -rf @PACKAGES_DIR@/libx2641.a
# fi
# cp @PACKAGES_DIR@/libx264.a @PACKAGES_DIR@/libx2641.a
# 
# ar -v -r -u @PACKAGES_DIR@/libx2641.a common/${SYS_ARCH}/bitstream-a-8.o common/${SYS_ARCH}/cabac-a-8.o common/${SYS_ARCH}/dct-a-8.o common/${SYS_ARCH}/deblock-a-8.o common/${SYS_ARCH}/mc-a-8.o common/${SYS_ARCH}/pixel-a-8.o common/${SYS_ARCH}/predict-a-8.o common/${SYS_ARCH}/quant-a-8.o common/${SYS_ARCH}/bitstream-a-10.o common/${SYS_ARCH}/cabac-a-10.o common/${SYS_ARCH}/dct-a-10.o common/${SYS_ARCH}/deblock-a-10.o common/${SYS_ARCH}/mc-a-10.o common/${SYS_ARCH}/pixel-a-10.o common/${SYS_ARCH}/predict-a-10.o common/${SYS_ARCH}/quant-a-10.o
# 
# if [ -f “@PACKAGES_DIR@/libx264.a” ]; then
    # rm -rf @PACKAGES_DIR@/libx264.a
# fi
# 
# cp @PACKAGES_DIR@/libx2641.a @PACKAGES_DIR@/libx264.a
# rm @PACKAGES_DIR@/libx2641.a

